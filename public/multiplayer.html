<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>ASTROVO â€” Multiplayer (1v1)</title>
<meta name="theme-color" content="#121212"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg1:#0f0c29;--bg2:#302b63;--bg3:#24243e;--accent:#00bcd4;--accent2:#26c6da;--muted:#90a4ae;--danger:#ef5350;}
  html,body{margin:0;height:100%;font-family:'Montserrat',sans-serif;color:#fff;background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 50%,var(--bg3) 100%);}
  #app{position:fixed;inset:0;display:grid;place-items:center}
  .frame{position:relative;width:min(100vw,56.25vh);height:calc(min(100vw,56.25vh)*(16/9));}
  iframe, .overlay{position:absolute;inset:0;border:0;border-radius:12px;overflow:hidden}
  .panel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;
    backdrop-filter:blur(6px);background:rgba(0,0,0,.55);padding:20px;text-align:center}
  .hidden{display:none}
  h1,h2{margin:0 0 10px 0;font-weight:600}
  input,button{font-family:inherit}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:none;min-width:200px}
  button{padding:12px 18px;border:none;border-radius:12px;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.3);
    background:linear-gradient(145deg,var(--accent),var(--accent2));color:#fff;font-size:16px}
  button.secondary{background:linear-gradient(145deg,#607d8b,#78909c)}
  button.danger{background:linear-gradient(145deg,#c62828,#ef5350)}
  #hud{position:absolute;top:8px;left:8px;right:8px;display:flex;justify-content:space-between;font-weight:600;pointer-events:none}
  #status{position:absolute;bottom:10px;left:0;right:0;text-align:center;opacity:.9}
</style>
</head>
<body>
<div id="app">
  <div class="frame">
    <iframe id="gameframe" src="index.html?embed=1"></iframe>

    <div id="menu" class="panel">
      <h1>ASTROVO â€” Multiplayer</h1>
      <p style="max-width:560px;opacity:.9">This uses the <b>exact same game</b> as singleplayer, embedded here for a 1v1 race. Last player alive wins.</p>
      <div class="row">
        <input id="playerName" type="text" placeholder="Your name" maxlength="20"/>
        <input id="room" type="text" placeholder="Room code (e.g. astro123)" maxlength="24"/>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="createBtn">Create room</button>
        <button class="secondary" id="joinBtn">Join</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="returnBtn" class="danger">Return</button>
      </div>
      <p style="margin-top:10px;font-size:14px;opacity:.85">Server: <code id="wsUrlLbl"></code></p>
    </div>

    <div id="lobby" class="panel hidden">
      <h2>Room <span id="roomLabel"></span></h2>
      <div id="playersList" style="margin:6px 0 12px"></div>
      <div class="row">
        <button id="readyBtn">I'm ready</button>
        <button class="secondary" id="leaveBtn">Leave</button>
      </div>
      <p id="lobbyInfo" style="margin-top:10px;opacity:.9">Waiting for both players to readyâ€¦</p>
    </div>

    <div id="countdown" class="panel hidden"><h1 id="cd">3</h1></div>

    <div id="overlay" class="panel hidden">
      <h1 id="resultTitle">Result</h1>
      <p id="resultBody"><span id="meName">You</span> vs <span id="oppName">Opponent</span></p>
      <div class="row">
        <button id="rematchBtn">Rematch</button>
        <button class="secondary" id="backLobbyBtn">Back to lobby</button>
      </div>
    </div>

    <div id="hud">
      <div id="timerLbl">Time: <span id="timeVal">0.0s</span></div>
      <div id="oppLbl">ðŸ†š <span id="oppNameHud">-</span> (<span id="oppAlive">alive</span>)</div>
    </div>
    <div id="status"></div>
  </div>
</div>
<script>
const qs = new URLSearchParams(location.search);
const defaultWS = qs.get('ws') || ((location.protocol==='https:'?'wss://':'ws://')+location.host);
document.getElementById('wsUrlLbl').textContent = defaultWS;
let ws, myId=null, room=null, playerName='', isReady=false;
let opponent = {id:null, name:'-', alive:true};
let startAt=0, started=false, myDead=false, oppDead=false;
const t0 = ()=> Date.now();
let localStartTime=0, timerId=0;

const el = (id)=>document.getElementById(id);
const menu = el('menu'), lobby = el('lobby'), countdown = el('countdown'), result = el('overlay');
const frame = document.getElementById('gameframe').contentWindow;

el('returnBtn').onclick = ()=>{ location.href='index.html'; };

function setStatus(t){ document.getElementById('status').textContent = t||''; }
function send(type, data){ if(ws && ws.readyState===1){ ws.send(JSON.stringify({type, ...data})); } }

async function connectWS(url){ return new Promise((res,rej)=>{ const s=new WebSocket(url); let opened=false; s.onopen=()=>{opened=true;res(s)}; s.onerror=e=>{if(!opened)rej(e)}; s.onclose=()=>setStatus('Connection closed'); }); }
async function startConn(){ ws = await connectWS(defaultWS); ws.onmessage = onWS; }

el('createBtn').onclick = async ()=>{ await startConn(); playerName = el('playerName').value.trim()||'Player'; room = el('room').value.trim()||('room'+Math.floor(Math.random()*999)); send('create',{room,name:playerName}); enterLobby('host'); };
el('joinBtn').onclick = async ()=>{ await startConn(); playerName = el('playerName').value.trim()||'Player'; room = el('room').value.trim(); if(!room){ alert('Enter a room code'); return; } send('join',{room,name:playerName}); enterLobby('guest'); };
el('leaveBtn').onclick = ()=>{ send('leave',{}); resetToMenu(); };
el('readyBtn').onclick = ()=>{ isReady=!isReady; send('ready',{ready:isReady}); el('readyBtn').textContent=isReady?'Not ready':"I'm ready"; };
el('backLobbyBtn').onclick = ()=>{ result.classList.add('hidden'); lobby.classList.remove('hidden'); };
el('rematchBtn').onclick = ()=>{ result.classList.add('hidden'); send('rematch',{}); resetRoundUI(); };

function enterLobby(role){ menu.classList.add('hidden'); lobby.classList.remove('hidden'); el('roomLabel').textContent=room; el('lobbyInfo').textContent = role==='host'?'The host will auto-start when both are ready.':'Waiting for hostâ€¦'; el('readyBtn').textContent="I'm ready"; isReady=false; setStatus('Connected as '+playerName); el('meName').textContent = playerName; }
function resetToMenu(){ menu.classList.remove('hidden'); lobby.classList.add('hidden'); countdown.classList.add('hidden'); result.classList.add('hidden'); setStatus(''); myId=null; room=null; isReady=false; opponent={id:null,name:'-',alive:true}; try{ ws && ws.close(); }catch{} }
function resetRoundUI(){ started=false; myDead=false; oppDead=false; el('oppAlive').textContent='alive'; el('timeVal').textContent='0.0s'; clearInterval(timerId); }

function onWS(ev){
  const msg = JSON.parse(ev.data||'{}');
  switch(msg.type){
    case 'hello': myId = msg.id; break;
    case 'roomState': updateRoomUI(msg); break;
    case 'start': startCountdown(msg.t||3, msg.startAt); break;
    case 'broadcast': handleSignal(msg.data||{}); break;
  }
}
function updateRoomUI(s){
  const list = (s.players||[]).map(p=> (p.name||'Player') + (p.ready?' âœ…':''));
  document.getElementById('playersList').textContent = list.join('  â€¢  ');
  if(s.players && s.players.length===2){
    const other = s.players.find(p=>p.id!==myId);
    opponent.id = other.id; opponent.name = other.name; opponent.alive = other.alive!==false;
    document.getElementById('oppName').textContent=opponent.name;
    document.getElementById('oppNameHud').textContent=opponent.name;
    document.getElementById('oppAlive').textContent=opponent.alive?'alive':'dead';
  }else{
    document.getElementById('oppNameHud').textContent='-';
  }
}
function handleSignal(d){
  if(d.kind==='dead'){ oppDead=true; document.getElementById('oppAlive').textContent='dead'; if(myDead) showResult(); }
  if(d.kind==='rematchAck'){ lobby.classList.remove('hidden'); resetRoundUI(); }
}

function startCountdown(n, srvStartAt){
  startAt = srvStartAt || (Date.now()+n*1000);
  countdown.classList.remove('hidden'); lobby.classList.add('hidden');
  let t=n; document.getElementById('cd').textContent=t;
  const it=setInterval(()=>{ t--; document.getElementById('cd').textContent=t; if(t<=0){ clearInterval(it); countdown.classList.add('hidden'); startRound(); } },1000);
}
function startRound(){
  started=true; myDead=false; oppDead=false;
  localStartTime = Date.now();
  // Start the embedded singleplayer game
  try{ frame.__mp && frame.__mp.start && frame.__mp.start(); }catch(e){ console.warn(e); }
  // start timer label
  timerId = setInterval(()=>{ const secs=((Date.now()-localStartTime)/1000).toFixed(1); document.getElementById('timeVal').textContent=secs+'s'; }, 100);
  setStatus('');
}

// Receive death signal from iframe
window.addEventListener('message', (e)=>{
  if(e && e.data && e.data.type==='mp-dead'){
    if(!myDead){ myDead=true; send('signal',{room, data:{kind:'dead'}}); if(oppDead) showResult(); }
  }
});

function showResult(){
  clearInterval(timerId);
  result.classList.remove('hidden');
}
</script>
</body>
</html>
